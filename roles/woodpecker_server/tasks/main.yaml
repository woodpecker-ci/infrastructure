- name: Create Woodpecker directory
  ansible.builtin.file:
    path: /opt/woodpecker
    state: directory
    mode: '0o700'
  tags:
    - woodpecker

- name: Woodpecker server container
  community.docker.docker_container:
    container_name: woodpecker_server
    hostname: woodpecker_server
    pull: 'always'
    image: woodpeckerci/woodpecker-server:{{ woodpecker_server_version }}
    restart: true
    restart_policy: 'always'
    volumes:
      - /opt/woodpecker:/var/lib/woodpecker/
    networks:
      - web
      - default
    env:
      WOODPECKER_OPEN: 'true'
      WOODPECKER_HOST: '{{ woodpecker_server_host }}'
      WOODPECKER_ORGS: '{{ woodpecker_server_orgs }}'
      WOODPECKER_ADMIN: '{{ woodpecker_server_admins }}'
      WOODPECKER_GITHUB: 'true'
      WOODPECKER_GITHUB_CLIENT: '{{ woodpecker_server_github_client }}'
      WOODPECKER_GITHUB_SECRET: '{{ woodpecker_server_github_secret }}'
      WOODPECKER_AGENT_SECRET: '{{ woodpecker_server_agent_secret }}'
      WOODPECKER_GITHUB_MERGE_REF: 'false'

  tags:
    - woodpecker
    - woodpecker-server
